//
//     Copyright Â© 2011-2015 Cambridge Intelligence Limited. 
//     All rights reserved.
// 

!function(){this.KeyLines=this.KeyLines||{};var n=KeyLines.Map={};n.init=function(n,t){function e(){return mt?o:i}function o(){throw new Error("Flash version does not support maps")}function i(){throw new Error("The Map library has not been loaded")}function a(){var t=[];return n.each({type:"node"},function(n){n.hi||t.push({id:n.id,x:n.x,y:n.y})}),t}function r(t,e){t?e():n.layout("standard",{animate:!1},e)}function s(n,t){var e=ht[st.transition]||vt;e(n,t)}function u(n,e){if(n){for(var o in n)st[o]=n[o];"tiles"in n&&$?x(e):t.invoke(e)}return t.clone(st)}function l(e){function o(){$=b(),C(i),h(!1),j(i)}function i(){l++,l>1&&a()}function a(){m(function(){it=!0,at=!1,n.trigger("map","showend"),t.invoke(e)})}if($||at)return t.invoke(e);at=!0,n.trigger("map","showstart"),ot=n.options();var r={navigation:!1,watermark:!1,overview:!1,gestures:!1};t.isNullOrUndefined(ot.backColour)&&(r.backColour="white"),n.options(r),et=[];var u={};n.each({type:"node"},function(n){n.hi||J(n)||(et.push(n.id),u[n.id]=!0)}),n.each({type:"link"},function(n){n.hi||!u[n.id1]&&!u[n.id2]||et.push(n.id)});var l=0;s(!0,function(){et.length>0?n.hide(et,{time:st.time,animate:st.animate},o):o()})}function f(){lt.style.top=null,lt.style.left=null,lt.parentNode.style.position=null}function m(t){f(),O(),st.animate?n.animateBackColourOpacity(0,{time:st.time},t):n.options({backColour:"rgba(255,255,255,0)"},t)}function c(t){var e=ot.backColour||"white";if(st.animate){var o=KeyLines.Rendering.opacity(e);n.animateBackColourOpacity(o,{time:st.time},t)}else n.options({backColour:e},t)}function p(e){function o(){it=!1,at=!1,n.trigger("map","hideend"),t.invoke(e)}function i(t,e,i,a){n.viewOptions(t,{animate:!1},function(){n.hide(et,{animate:!1},function(){n.setProperties(e,!1,function(){n.allowDraw(!0),n.viewOptions(i,{animate:!0,time:st.time}),n.animateProperties(a,{time:st.time},function(){et.length>0?n.show(et,!1,{animate:!0,time:st.time},o):o()})})})})}function r(){c(function(){w(),$=nt=null,n.options(ot);var t,e;st.animate&&(t=n.viewOptions(),e=a(),n.allowDraw(!1)),n.show(et,!1,{animate:!1},function(){s(!1,function(){n.zoom("fit",{animate:!1},function(){if(st.animate){var r=n.viewOptions(),s=a();i(t,e,r,s)}else o()})})})})}if(!$||at)return t.invoke(e);at=!0,n.trigger("map","hidestart");var u=d();u.length&&$.getZoom()!==$.getBoundsZoom(L.latLngBounds(u))?($.once("zoomend",r),v(u,st.animate)):r()}function d(){var t=[];return n.each({type:"node"},function(n){J(n)&&!n.hi&&t.push(L.latLng(n.pos.lat,n.pos.lng))}),t}function v(n,t){n.length?$.fitBounds(L.latLngBounds(n),{animate:t,padding:[5,5]}):$.setView(L.latLng(0,0),2,{animate:t})}function h(n){v(d(),n)}function y(n){if(!n)return-1;for(var t=0,e=n;e=e.previousSibling;)++t;return t}function g(n,t){var e=ft>0?n.childNodes[ft+1]:n.firstChild;n.insertBefore(t,e||null)}function w(){var n=$._container,t=n.parentNode,e=t.parentNode;$.removeLayer(nt),$.remove(),e.removeChild(t),g(e,lt),lt.style.position="",lt.style["-ms-transform"]="",lt.style["-moz-transform"]="",lt.style["-webkit-transform"]="",lt.style.transform="",lt.style.zIndex=""}function z(n){lt.style.position="absolute",lt.style.top=0,lt.style.left=0,lt.style.zIndex=9999;var t=document.createElement("div");t.style.position="relative",t.id=n+"-container";var e=document.createElement("div");e.id=n,e.style.width=t.style.width=lt.clientWidth+"px",e.style.height=t.style.height=lt.clientHeight+"px",e.style.position="absolute",e.style.top=lt.top,e.style.left=lt.left;var o=lt.parentNode;o.removeChild(lt),t.appendChild(e),t.appendChild(lt),g(o,t)}function b(){return z(rt),new L.Map(rt,{zoomAnimationThreshold:20})}function C(n){var t="",e={noWrap:!0};"string"!=typeof st.tiles?(t=(st.tiles||ut.tiles).url,e=L.extend(e,st.tiles)):t=st.tiles,tt=new L.TileLayer(t,e),n&&tt.once("load",n),$.addLayer(tt)}function x(n){$.removeLayer(tt),C(n)}function O(n){nt=Q(n),$.addLayer(nt)}function k(n){n&&(dt.options=t.defaults(n,zt),$&&Z())}function P(n){dt={options:t.clone(zt),view:null,zooming:null,zoomLevel:null},k(n)}function B(){if(!n)throw new Error("[Map] A chart must be specified!");lt.parentNode.removeChild(lt),$.getPanes().overlayPane.appendChild(lt),K()}function M(){N(!1),U(!1),n.viewOptions(dt.view)}function Z(){$.off("zoomanim",T),dt.options.animZoom&&$.on("zoomanim",T)}function K(){n.options({dragPan:!1,handMode:!0,hover:5}),G([]),N(!0),U(!0)}function N(n){var t=n?"on":"off";$[t]({mousedown:S,resize:A,move:D}),dt.zooming=!1,dt.zoomLevel=$._zoom,$[t]("zoomstart",E),(!n||dt.options.animZoom)&&$[t]("zoomanim",T),$[t]("zoomend",Y)}function E(){dt.zooming=!0}function T(n){I(n)}function Y(){dt.zooming=!1,dt.options.animZoom||V()}function D(n){X(n),V()}function S(t){var e=t.originalEvent,o=KeyLines.coords(e);n.mousedown(e.button,o.x,o.y,e.ctrlKey,e.shiftKey)}function X(){var n=$.getPixelBounds().min,t=$.getPixelOrigin(),e=L.point(n.x-t.x,n.y-t.y);L.DomUtil.setPosition(lt,e)}function A(){V()}function I(t){var e=[];n.each({type:"node"},function(o){if(J(o)){var i=$._latLngToNewLayerPoint(L.latLng(o.pos.lat,o.pos.lng),t.zoom,t.center),a=$.layerPointToContainerPoint(i),r=n.worldCoordinates(a.x,a.y);e.push({id:o.id,x:r.x,y:r.y})}}),n.animateProperties(e,{time:150,queue:!1})}function U(t){var e=t?"bind":"unbind";n[e]("dblclick",_),n[e]("dragstart",W),n[e]("viewchange",q),n[e]("keydown",R)}function _(){return!0}function R(n){return n>36&&41>n}function W(n){return"offset"!==n}function q(){var t=n.viewOptions(),e=dt.view.offsetX!==t.offsetX,o=dt.view.offsetY!==t.offsetY;(e||o)&&(t.offsetX=dt.view.offsetX,t.offsetY=dt.view.offsetY,n.viewOptions(t,{animate:!1}))}function F(){var t=[];return n.each({type:"node"},function(e){if(J(e)){var o=$.latLngToContainerPoint(L.latLng(e.pos.lat,e.pos.lng)),i=n.worldCoordinates(o.x,o.y);i.id=e.id,t.push(i)}}),t}function H(){var n=$.getZoom();n=Math.min(Lt,Math.max(wt,n));var t=yt+(gt-yt)*(n-wt)/(Lt-wt);return t}function V(t){n.viewOptions({zoom:H()},{animate:!1},function(){n.setProperties(F(),!1,t)})}function j(e){if(st.animate){var o=n.viewOptions(),i=H();o.zoom===i?n.animateProperties(F(),{time:st.time},e):n.viewOptions({zoom:i},{animate:!1},function(){var a=F();n.viewOptions(o,{animate:!1},function(){function o(){0===--r&&t.invoke(e)}var r=2;n.viewOptions({zoom:i},{animate:!0,time:st.time},o),n.animateProperties(a,{animate:!0,time:st.time},o)})})}else V(e)}function G(n){for(var t=0;t<n.length;t++)$[n[t]]&&$[n[t]].disable()}function J(n){return n.pos&&n.pos.lat&&n.pos.lng}function Q(){var n=L.Class.extend({setOptions:k,initialize:P,onAdd:B,onRemove:M});return new n(st)}var $,nt,tt,et=[],ot={},it=!1,at=!1,rt=n.id()+"-map",st={animate:!0,time:800,tiles:{id:"tiles-toner",url:"http://{s}.tile.stamen.com/toner-lite/{z}/{x}/{y}.png",attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',subdomains:"abcd",minZoom:0,maxZoom:20},transition:"restore"},ut=KeyLines.Util.clone(st),lt=document.getElementById(n.id()),ft=y(lt),mt=!n.canvas,ct="undefined"!=typeof L&&L.version,pt=mt||!ct;n.map=function(){return{show:pt?e():l,hide:pt?e():p,isShown:function(){return it},options:pt?e():u}};var dt,vt=function(){function t(t,o){t?(e=a(),o()):n.setProperties(e,!1,o)}var e;return t}(),ht={restore:vt,layout:r},yt=.75,gt=1.25,wt=4,Lt=15,zt={animZoom:!0,scaleOnZoom:!0}}}();;

